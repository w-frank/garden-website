<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Will Frank</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Will Frank">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <link href="/static/css/colorbox.css" rel="stylesheet">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
        <link href="/static/css/style.css" rel="stylesheet">

        <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Space Mono">
        <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Poppins" >
        
    </head>
    <body>
        <div class="container">
            <nav class="navbar navbar-default" role="navigation">
                    <div class="navbar-header">
                        <h1 class="navbar-brand" href="https://willfrank.co.uk">Will Frank</h1>
                    </div>
                    <!--<div class="collapse navbar-collapse">-->
                    <ul class="nav navbar-nav">
                                <li><a href="/">Home</a></li>
                                <li><a href="/pages/portfolio.html">Portfolio</a></li>
                                <li><a href="/pages/about.html">About</a></li>
                    </ul>
                    <!--</div>-->
            </nav>
<div class="row">
    <div class="col-md-8">
        <h1><a href="/stm32-vcp.html">STM32: USB Virtual COM Port (VCP)</a></h1>
        <label class="tag" href="/tags/STM32.html">STM32</label>
        <label class="tag" href="/tags/ARM.html">ARM</label>
        <label class="tag" href="/tags/linux.html">linux</label>
        <label class="tag" href="/tags/programming.html">programming</label>
        </label>
        <label class="font-weight-normal text-muted">&#8226 13 February, 2022</label>
        <p><p>virtual COM port.</p>
<p>Serial communication is useful for interfacing microcontrollers with external
devices or to a host PC for debugging or data transfer. For STM32
devices a USB-UART bridge can be used to communicate with a USB device such as
a PC. However, many of the STM32 development boards have a USB peripheral
on-board. This tutorial covers setting up the STM32F4 Discovery board as a
virtual COM port (VCP).</p>
<p>I'm using the STM32 Discovery board which has an STM32F407VG microcontroller and
an on-board micro USB port. I'm using the STM32 Cube Framework with the HAL
libraries and USB device middleware for this application.</p>
<p>Open STM32 CubeIDE and start a new STM32 project. Select your microcontroller
and/or board. Here I select the STM32F4 Discovery.</p>
<p>Now in the STM32 CubeMX perspective, enable the High Speed External (HSE)
clock and select Ceramic/Crystal Resonator.</p>
<p>Under the Connectivity section select the mode as Device_Only.</p>
<p>Finally, under the Middleware section, select the USB_DEVICE and set the
Class For FS IP as Communication Device Class (Virtual Port Com).</p>
<p>Next, save the CubeMX (.ioc) file to generate the code. Now all the peripherals 
are enabled for the USB communication over VCP. But as the HAL USB stack is
heavy on the memory, the minimum heap size needed has to be changed. This can be
changed by opening the STM32F407VGTX_FLASH.ld linker script file and changing
the line 59 to _Min_Heap_Size = 0x600;.</p>
<p>Lets test this setup with a simple echo application using the USB CDC. First
open the usbd_cdc_if.c file. Find the CDC_Receive_FS function and edit:</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span> <span class="kt">int8_t</span> <span class="nf">CDC_Receive_FS</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">Buf</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">Len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* USER CODE BEGIN 6 */</span>
    <span class="n">USBD_CDC_SetRxBuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hUsbDeviceFS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">USBD_CDC_ReceivePacket</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hUsbDeviceFS</span><span class="p">);</span>
    <span class="n">CDC_Transmit_FS</span><span class="p">(</span><span class="n">Buf</span><span class="p">,</span><span class="o">*</span><span class="n">Len</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">USBD_OK</span><span class="p">);</span>
    <span class="cm">/* USER CODE END 6 */</span>
<span class="p">}</span>
</code></pre></div>

<p>Now build the project and download the program to the board using the built in
ST-Link.</p>
<p>When connected to your host PC by the micro USB (next to the audio jack on the 
STM32F4 Discovery board), the serial port should show up as <em>/dev/ttyACM1</em> on
most Linux distributions. Start a serial port terminal, such as gtkterm and open
<em>ttyACM1</em>. The baud rate doesn't matter as it's ignored by the progam. On Ubuntu:</p>
<div class="highlight"><pre><span></span><code>sudo apt-get install gtkterm
sudo gtkterm
</code></pre></div>

<p>Type a message in the serial monitor and press send. Then the STM32 device will
echo back the message you typed.</p>
<h2>Controlling a built-in LED using the VCP</h2>
<p>The Virtual COM Port (VCP) opens up the possibility of remote control of the
STM32. As a simple example, the built-in LED on the STM32F4 Discovery can be
turned on and off using the VCP. First, open the CubeMX (.ioc ) file again to
generate the code for the LED. In the CubeMX perspective, select the pin for the
LED (which is PD13 for the orange LED of the STMF4 Discovery board) and set as
GPIO_Output. Now save the file to generate the code again. Next change the
CDC_Receive_FS function in the usbd_cdc_if file as follows:</p>
<div class="highlight"><pre><span></span><code>static int8_t CDC_Receive_FS<span class="o">(</span>uint8_t* Buf, uint32_t *Len<span class="o">)</span>
<span class="o">{</span>
    /* USER CODE BEGIN <span class="m">6</span> */
    USBD_CDC_SetRxBuffer<span class="o">(</span><span class="p">&amp;</span>hUsbDeviceFS, <span class="p">&amp;</span>Buf<span class="o">[</span><span class="m">0</span><span class="o">])</span><span class="p">;</span>
    USBD_CDC_ReceivePacket<span class="o">(</span><span class="p">&amp;</span>hUsbDeviceFS<span class="o">)</span><span class="p">;</span>
    <span class="k">if</span><span class="o">(</span>Buf<span class="o">[</span><span class="m">0</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="o">)</span>
    <span class="o">{</span>
        HAL_GPIO_WritePin<span class="o">(</span>GPIOD, GPIO_PIN_13, GPIO_PIN_SET<span class="o">)</span><span class="p">;</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="o">(</span>Buf<span class="o">[</span><span class="m">0</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="o">)</span>
    <span class="o">{</span>
        HAL_GPIO_WritePin<span class="o">(</span>GPIOD, GPIO_PIN_13, GPIO_PIN_RESET<span class="o">)</span><span class="p">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="o">(</span>USBD_OK<span class="o">)</span><span class="p">;</span>
    /* USER CODE END <span class="m">6</span> */
<span class="o">}</span>
</code></pre></div></p>
        <h2>Comments</h2>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'willfrank-co-uk'; 

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
    <div class="col-md-3">
        <h4>Recent Posts</h4>
        <ul id="recent-posts">
            <li><a href="/stm32-vcp.html">STM32: USB Virtual COM Port (VCP)</a></li>
            <li><a href="/sending-files-with-kermit-1.html">Sending Files Over Serial With Kermit</a></li>
            <li><a href="/port-audio-1.html">Build and Use PortAudio on Linux (using CMake)</a></li>
        </ul>
        <!--
        <h4>Categories</h4>
        <ul id="category-list">
            <li><a href="/category/linux.html">Linux</a></li>
            <li><a href="/category/stm32.html">STM32</a></li>
        </ul>
        -->
        <h4>Tags</h4>
        <ul id="tag-list">
            <li><a href="/tag/stm32.html">STM32</a></li>
            <li><a href="/tag/arm.html">ARM</a></li>
            <li><a href="/tag/linux.html">linux</a></li>
            <li><a href="/tag/programming.html">programming</a></li>
        </ul>
    </div>
</div>
        </div>
        <footer class="blog-footer">
            <div class="container">
                <span class="text-muted">Will Frank 2022. Handcrafted using <a href="https://www.python.org/">Python</a>, <a href="https://docs.getpelican.com/en/stable/">Pelican</a> and <a href="https://getbootstrap.com/">Bootstrap</a>. Published with <a href="https://pages.github.com/">GitHub Pages.</a></span>
            </container>
        </footer>

        <script src="/static/js/jquery.min.js"></script>
        <!-- Make sure jquery is loaded first, then load colorbox -->
        <script src="/static/js/jquery.colorbox-min.js"></script>
        <script src="/static/js/load-colorbox.js"></script>
        <script type="text/javascript">
            $(document).ready(function () {
                var url = window.location;
                $('.navbar-nav a[href="'+ url +'test"]').parent().addClass('active');
                $('.navbar-nav a').filter(function() {
                     return this.href == url;
                }).parent().addClass('active');
            });
        </script> 
    </body>
</html>